apiVersion: batch/v1
kind: CronJob
metadata:
  name: email-pipeline-run
  namespace: email-pipeline
  labels:
    app.kubernetes.io/name: email-pipeline
    app.kubernetes.io/component: pipeline
spec:
  # Run every 6 hours
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 1800
      template:
        metadata:
          labels:
            app.kubernetes.io/name: email-pipeline
            app.kubernetes.io/component: pipeline
        spec:
          restartPolicy: OnFailure
          containers:
            - name: pipeline
              image: email-pipeline:latest
              command: ["email-pipeline"]
              args:
                - "run-all"
                - "--provider"
                - "gmail"
                - "--window"
                - "6h"
                - "--resume"
                - "/app/resumes/resume.json"
                - "--questionnaire"
                - "/app/config/questionnaire.json"
                - "--rules"
                - "/app/config/filter_rules.json"
                - "--work-dir"
                - "/app/data"
                - "--out-dir"
                - "/app/output"
              env:
                - name: OPENAI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: email-pipeline-secrets
                      key: OPENAI_API_KEY
                - name: GMAIL_CREDENTIALS_PATH
                  value: /app/secrets/gmail/credentials.json
                - name: GMAIL_TOKEN_PATH
                  value: /app/secrets/gmail/token.json
              volumeMounts:
                - name: pipeline-data
                  mountPath: /app/data
                - name: pipeline-output
                  mountPath: /app/output
                - name: pipeline-resumes
                  mountPath: /app/resumes
                - name: gmail-credentials
                  mountPath: /app/secrets/gmail
                  readOnly: true
                - name: pipeline-config
                  mountPath: /app/config
                  readOnly: true
              resources:
                requests:
                  cpu: 200m
                  memory: 512Mi
                limits:
                  cpu: "1"
                  memory: 1Gi
          volumes:
            - name: pipeline-data
              persistentVolumeClaim:
                claimName: pipeline-data
            - name: pipeline-output
              persistentVolumeClaim:
                claimName: pipeline-output
            - name: pipeline-resumes
              persistentVolumeClaim:
                claimName: pipeline-resumes
            - name: gmail-credentials
              secret:
                secretName: gmail-credentials
            - name: pipeline-config
              configMap:
                name: pipeline-config
